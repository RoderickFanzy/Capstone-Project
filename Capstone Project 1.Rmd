---
title: "Capstone Project"
author: "Roderick Fan"
date: "2023-03-29"
output: html_document
---

Clean Environment
Loading Packages, dataset
```{r}
rm(list = ls())
cat("\14")
library(tidyverse)
library(here)
library(lubridate)
spot <- read.csv(here("Spot Data.csv"))
```

Preprocessing
```{r}
#Rename Patient ID
spot$Patient.ID <- as.numeric(factor(spot$Patient.ID, levels=unique(spot$Patient.ID)))

#Binomial Sex
spot$Patient.Sex <- as.factor(spot$Patient.Sex)

#Dropping Redundant Predictors   
t(t(colnames(spot)))
spot <- spot[,-c(5)]

#Factoring Specimen Type
spot$Specimen.Type <- as.factor(spot$Specimen.Type)

#Factoring and Renaming Client Location
spot$Client.ID <- as.factor(spot$Client.ID)
levels(spot$Client.ID) <- c("Location A","Location B","Location C","Location D","Location E","Location F",
                            "Location G","Location H","Location I","Location J","Location K","Location L",
                            "Location M","Location N","Location O","Location P","Location Q","Location R")
table(spot$Client.ID)

#Convert and Simplify Datetime Columns
datetime_cols <- c("Datetime.Kit.Delivered", "Datetime.Kit.Registered", "Datetime.Sample.Sent.In", "Datetime.Sample.Received", "Datetime.of.End.Status")

for (col in datetime_cols) {
  spot[[col]] <- as.Date(substr(spot[[col]], 1, 10), format="%Y-%m-%d")
}

table(spot$End.Status)
```


```{r}
#Calculate Time Gap between Sent in and Resulted
spot$time.gap <- as.numeric(difftime(spot$Datetime.of.End.Status, spot$Datetime.Sample.Sent.In,units = "day"))

t(t(colnames(spot)))
spot.clean <- spot[,-c(7,8,10)]
spot.clean <- na.omit(spot.clean)
spot.clean <- spot.clean[!(spot.clean$End.Status %in% c("collected", "collection_exception","delivered","delivery_exception","partially_resulted","received")),]
reject <- subset(spot.clean, End.Status == "rejected")


hist(spot.clean$time.gap)


threshold <-  1.5*(IQR(spot.clean$time.gap))
outliers <- spot.clean$time.gap < median(spot.clean$time.gap) - threshold | spot.clean$time.gap > median(spot.clean$time.gap) + threshold
spot.clean <- spot.clean[!outliers,]

View(spot)
View(spot.clean)

test.rate <- spot %>%
  group_by(Specimen.Type) %>%
  summarize(Count = n(), resulted_rate = sum(End.Status == "resulted")/n())

test.duration <- spot%>%
  count(Patient.ID)

ggplot(data = test.duration)+
  geom_histogram(aes(x = n, stat = "Identity"), binwidth = 0.5)+
  xlim(0.5,5)+
  coord_flip()+
  theme_classic()+
  labs( x = "Number of Tests Patient Takes",
        y = "Number of Patient",
        title = "Count Plot for Patient Use Duration")


ggplot(test.rate, aes(x = reorder(Specimen.Type,Count), y = resulted_rate, fill = Specimen.Type)) +
  geom_bar(aes(y = Count),stat = "identity", alpha = 0.5, width = 0.5) +
  geom_text(aes(label = paste0(round(resulted_rate*100,2), "%"), y = Count + 1), 
            color = "black", fontface = "bold", size = 4, hjust = -0.1) +
  labs(x = "", y = "Count / Success Rate", 
       title = "Success Rate and Count by Specimen Type") +
  scale_fill_discrete(name = "Specimen Type") +
  scale_y_continuous(sec.axis = sec_axis(~./max(test.rate$count), name = "Count"))+
  ylim(0,8000)+
  coord_flip()+
  theme_classic()+
  theme(legend.position = "none")
```





```{r}

timeseries <- as.data.frame(table(spot$Datetime.Kit.Delivered))
timeseries.ts <- ts(data = timeseries$Freq, start = c(2021, 12), frequency = 365)
plot(timeseries.ts)



```





